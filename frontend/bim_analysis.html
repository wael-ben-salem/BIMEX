<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIM Analysis - Interface d'Analyse Intelligente</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .feature-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border-left: 5px solid #3498db;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .feature-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .feature-card p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #2980b9;
            background: #e8f4f8;
        }

        .upload-area.dragover {
            border-color: #27ae60;
            background: #e8f5e8;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .action-btn {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .action-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .results-area {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .results-area.show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .metric-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .anomaly-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #e74c3c;
        }

        .anomaly-critical { border-left-color: #c0392b; }
        .anomaly-high { border-left-color: #e67e22; }
        .anomaly-medium { border-left-color: #f39c12; }
        .anomaly-low { border-left-color: #95a5a6; }

        .chat-area {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }

        .chat-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
        }

        .chat-message.user {
            background: #e3f2fd;
            text-align: right;
        }

        .chat-message.assistant {
            background: #f1f8e9;
        }

        .chat-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 1em;
            margin-top: 10px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .tabs {
            display: flex;
            background: #ecf0f1;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #ecf0f1;
            border: none;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #3498db;
            font-weight: bold;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 0 0 10px 10px;
        }

        .tab-content.active {
            display: block;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success { background: #27ae60; }
        .status-warning { background: #f39c12; }
        .status-error { background: #e74c3c; }
        .status-info { background: #3498db; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèóÔ∏è BIM Analysis Platform</h1>
            <p>Analyse intelligente de vos fichiers IFC avec IA</p>
        </div>

        <div class="main-content">
            <!-- Zone fichier pr√©-s√©lectionn√© -->
            <div class="upload-area" id="uploadArea" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); border: 2px solid #10b981;">
                <h3>‚úÖ Fichier D√©tect√© Automatiquement</h3>
                <div id="selectedFileInfo" style="background: rgba(255,255,255,0.8); padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <p><strong>üìÅ Fichier:</strong> <span id="detectedFileName">Chargement...</span></p>
                    <p><strong>üÜî Projet:</strong> <span id="detectedProjectId">Chargement...</span></p>
                    <p><strong>üìÇ Chemin:</strong> <span id="detectedFilePath">Chargement...</span></p>
                    <p><strong>üîó Source:</strong> XeoKit BIM Viewer</p>
                    <button onclick="resetAutoMode()" style="
                        background: #6b7280;
                        color: white;
                        border: none;
                        padding: 5px 10px;
                        border-radius: 5px;
                        font-size: 0.8rem;
                        margin-top: 10px;
                        cursor: pointer;
                    ">üîÑ R√©initialiser (Test)</button>
                </div>
                <p style="color: #059669; font-weight: bold;">üöÄ Pr√™t pour l'analyse automatique !</p>
                <input type="file" id="fileInput" class="file-input" accept=".ifc" style="display: none;">
                <div id="fileName" style="margin-top: 10px; font-weight: bold; color: #2c3e50;"></div>
            </div>

            <!-- Boutons d'action -->
            <div style="text-align: center; margin: 20px 0;">
                <button class="action-btn" id="analyzeBtn" onclick="analyzeFile()" disabled>
                    üîç Analyser le fichier
                </button>
                <button class="action-btn" id="detectAnomaliesBtn" onclick="detectAnomalies()" disabled>
                    üö® D√©tecter les anomalies
                </button>
                <button class="action-btn" id="classifyBtn" onclick="classifyBuilding()" disabled>
                    üè¢ Classifier le b√¢timent
                </button>
                <button class="action-btn" id="generateReportBtn" onclick="generateReport()" disabled>
                    üìÑ G√©n√©rer un rapport
                </button>
                <button class="action-btn" id="analyzePMRBtn" onclick="analyzePMR()" disabled>
                    ‚ôø Analyse PMR
                </button>
                <button class="action-btn" id="loadAssistantBtn" onclick="loadAssistant()" disabled>
                    ü§ñ Charger l'assistant IA
                </button>
                <button class="action-btn" id="clearCacheBtn" onclick="clearCache()" style="background: linear-gradient(135deg, #f59e0b, #d97706); font-size: 0.9em;">
                    üßπ Effacer le cache
                </button>
            </div>

            <!-- Zone de r√©sultats avec onglets -->
            <div class="results-area" id="resultsArea">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('analysis')">Analyse</button>
                    <button class="tab" onclick="showTab('anomalies')">Anomalies</button>
                    <button class="tab" onclick="showTab('classification')">Classification</button>
                    <button class="tab" onclick="showTab('pmr')">PMR</button>
                    <button class="tab" onclick="showTab('assistant')">Assistant IA</button>
                </div>

                <div id="analysisTab" class="tab-content active">
                    <h3>üìä R√©sultats d'analyse</h3>
                    <div id="analysisResults"></div>
                </div>

                <div id="anomaliesTab" class="tab-content">
                    <h3>üö® Anomalies d√©tect√©es</h3>
                    <div id="anomaliesResults"></div>
                </div>

                <div id="classificationTab" class="tab-content">
                    <h3>üè¢ Classification du b√¢timent</h3>
                    <div id="classificationResults"></div>
                </div>

                <div id="pmrTab" class="tab-content">
                    <h3>‚ôø Analyse d'Accessibilit√© PMR</h3>
                    <div id="pmrResults"></div>
                </div>

                <div id="assistantTab" class="tab-content">
                    <h3>ü§ñ Assistant IA Conversationnel</h3>
                    <div id="assistantStatus"></div>
                    <div class="chat-area" id="chatArea"></div>
                    <input type="text" class="chat-input" id="chatInput" placeholder="Posez votre question sur le mod√®le BIM..." onkeypress="handleChatKeyPress(event)">
                    <div style="margin-top: 10px;">
                        <button class="action-btn" onclick="sendChatMessage()">Envoyer</button>
                        <button class="action-btn" onclick="clearChat()">Effacer</button>
                    </div>
                    <div id="suggestedQuestions" style="margin-top: 15px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFile = null;
        let sessionId = null;

        // üöÄ CORRECTION: Cache pour √©viter les re-analyses (TOUS LES BOUTONS)
        let analysisCache = {
            comprehensive: null,    // üîç Analyser le fichier
            classification: null,   // üè¢ Classifier le b√¢timent
            pmr: null,             // ‚ôø Analyse PMR
            anomalies: null,       // üö® D√©tecter les anomalies
            assistant: null,       // ü§ñ Charger l'assistant IA
            timestamp: null,
            projectId: null
        };

        // Configuration de l'API
        const API_BASE = 'http://localhost:8000';

        // üöÄ FONCTIONS DE CACHE
        function getCacheKey() {
            return currentFile?.project || currentFile?.name || 'default';
        }

        function isCacheValid(cacheType) {
            const cacheKey = getCacheKey();
            if (!analysisCache[cacheType] || analysisCache.projectId !== cacheKey) {
                return false;
            }

            // Cache valide pendant 10 minutes
            const cacheAge = Date.now() - analysisCache.timestamp;
            return cacheAge < 10 * 60 * 1000; // 10 minutes
        }

        function setCache(cacheType, data) {
            const cacheKey = getCacheKey();
            analysisCache[cacheType] = data;
            analysisCache.projectId = cacheKey;
            analysisCache.timestamp = Date.now();
            console.log(`üöÄ Cache mis √† jour pour ${cacheType}: ${cacheKey}`);
        }

        function getCache(cacheType) {
            if (isCacheValid(cacheType)) {
                console.log(`‚ö° Utilisation du cache pour ${cacheType}`);
                return analysisCache[cacheType];
            }
            return null;
        }

        function clearCache() {
            analysisCache = {
                comprehensive: null,
                classification: null,
                pmr: null,
                anomalies: null,
                assistant: null,
                timestamp: null,
                projectId: null
            };
            console.log('üßπ Cache effac√© pour tous les boutons');
        }

        // Gestion du drag & drop
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            if (!file.name.toLowerCase().endsWith('.ifc')) {
                alert('Veuillez s√©lectionner un fichier IFC');
                return;
            }

            currentFile = file;
            document.getElementById('fileName').textContent = `Fichier s√©lectionn√©: ${file.name}`;
            
            // Activer les boutons
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('detectAnomaliesBtn').disabled = false;
            document.getElementById('classifyBtn').disabled = false;
            document.getElementById('generateReportBtn').disabled = false;
            document.getElementById('analyzePMRBtn').disabled = false;
            document.getElementById('loadAssistantBtn').disabled = false;
        }

        function showTab(tabName) {
            // Masquer tous les onglets
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Afficher l'onglet s√©lectionn√©
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analyse en cours...</p>
                </div>
            `;
        }

        async function analyzeFile() {
            if (!currentFile) return;

            // üöÄ CORRECTION: V√©rifier le cache d'abord
            const cachedResult = getCache('comprehensive');
            if (cachedResult) {
                console.log('‚ö° Utilisation des donn√©es en cache pour l\'analyse compl√®te');
                displayAnalysisResults(cachedResult.analysis);
                document.getElementById('resultsArea').classList.add('show');
                showTab('analysis');
                return;
            }

            showLoading('analysisResults');
            document.getElementById('resultsArea').classList.add('show');
            showTab('analysis');

            try {
                let response, result;

                // üîß CORRECTION: Ajouter des logs pour d√©boguer
                console.log('üîç Analyse - currentFile:', currentFile);
                console.log('üîç Mode auto:', currentFile?.auto);
                console.log('üîç Source:', currentFile?.source);
                console.log('üîç Projet:', currentFile?.project);

                // V√©rifier si c'est le mode automatique avec un projet
                if (currentFile && currentFile.auto && currentFile.source === 'xeokit' && currentFile.project) {
                    console.log(`üîç Analyse automatique du projet: ${currentFile.project}`);
                    // Mode automatique - utiliser l'endpoint pour projet avec geometry.ifc
                    response = await fetch(`${API_BASE}/analyze-comprehensive-project/${currentFile.project}`);
                    result = await response.json();
                } else {
                    // Mode normal - upload de fichier
                    if (!currentFile || typeof currentFile.name === 'undefined') {
                        throw new Error('Aucun fichier s√©lectionn√© ou mode auto mal configur√©');
                    }

                    const formData = new FormData();
                    formData.append('file', currentFile);

                    response = await fetch(`${API_BASE}/analyze-ifc`, {
                        method: 'POST',
                        body: formData
                    });
                    result = await response.json();
                }

                if (result.status === 'success') {
                    console.log('Donn√©es d\'analyse re√ßues:', result);

                    // üöÄ CORRECTION: Mettre en cache le r√©sultat
                    setCache('comprehensive', result);

                    if (result.analysis) {
                        displayAnalysisResults(result.analysis);
                    } else {
                        // üîß CORRECTION: Afficher les donn√©es disponibles m√™me si la structure est diff√©rente
                        console.warn('Structure de donn√©es inattendue:', result);
                        document.getElementById('analysisResults').innerHTML = `
                            <div class="metric-card" style="border-left-color: #f59e0b;">
                                <div class="metric-value">‚úÖ Analyse Termin√©e</div>
                                <div class="metric-label">Donn√©es re√ßues avec succ√®s</div>
                                <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                    Structure de donn√©es: ${Object.keys(result).join(', ')}
                                </div>
                            </div>
                        `;
                    }
                } else {
                    throw new Error(result.detail || result.message || 'Erreur d\'analyse');
                }
            } catch (error) {
                console.error('Erreur lors de l\'analyse:', error);

                // üîß CORRECTION: Meilleure gestion des erreurs
                let errorMessage = 'Erreur inconnue';

                if (typeof error === 'string') {
                    errorMessage = error;
                } else if (error && error.message) {
                    errorMessage = error.message;
                } else if (error && typeof error === 'object') {
                    // Essayer d'extraire des informations utiles de l'objet
                    if (error.detail) {
                        errorMessage = error.detail;
                    } else if (error.error) {
                        errorMessage = error.error;
                    } else {
                        errorMessage = `Erreur d'analyse: ${JSON.stringify(error, null, 2)}`;
                    }
                }

                document.getElementById('analysisResults').innerHTML = `
                    <div class="anomaly-item anomaly-critical">
                        <strong>üö® Erreur d'Analyse:</strong><br>
                        <div style="margin-top: 10px; padding: 10px; background: #fee; border-radius: 5px; font-family: monospace; font-size: 0.9em;">
                            ${errorMessage}
                        </div>
                        <div style="margin-top: 10px; color: #666; font-size: 0.8em;">
                            üí° V√©rifiez que le backend est d√©marr√© et que le fichier IFC est valide.
                        </div>
                    </div>
                `;
            }
        }

        function displayAnalysisResults(analysis) {
            console.log('üîç Structure d\'analyse re√ßue:', analysis);

            // üîß CORRECTION: Adapter √† la nouvelle structure de r√©ponse
            let metrics, projectInfo, anomalies, classification, pmr;

            if (analysis.analysis_results) {
                // Nouvelle structure compl√®te
                const results = analysis.analysis_results;
                metrics = results.metrics?.data?.building_metrics || results.metrics?.data;
                projectInfo = results.metrics?.data?.project_info;
                anomalies = results.anomalies;
                classification = results.classification;
                pmr = results.pmr;
            } else {
                // Structure ancienne (fallback)
                metrics = analysis.building_metrics;
                projectInfo = analysis.project_info;
            }

            // üîß CORRECTION: V√©rifier que nous avons des donn√©es √† afficher
            if (!metrics && !projectInfo && !anomalies && !classification && !pmr) {
                console.warn('Aucune donn√©e d\'analyse trouv√©e dans:', analysis);
                document.getElementById('analysisResults').innerHTML = `
                    <div class="metric-card" style="border-left-color: #f59e0b;">
                        <div class="metric-value">‚ö†Ô∏è Donn√©es Incompl√®tes</div>
                        <div class="metric-label">Analyse partiellement r√©ussie</div>
                        <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                            Structure re√ßue: ${Object.keys(analysis).join(', ')}<br>
                            Consultez la console pour plus de d√©tails.
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="metric-card">
                    <div class="metric-value">${projectInfo?.project_name || 'Projet Basic2'}</div>
                    <div class="metric-label">Nom du projet</div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="metric-card">
                        <div class="metric-value">${Math.round(metrics?.surfaces?.total_floor_area || 0).toLocaleString()}</div>
                        <div class="metric-label">Surface totale (m¬≤)</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-value">${metrics?.storeys?.total_storeys || 0}</div>
                        <div class="metric-label">Nombre d'√©tages</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-value">${metrics?.spaces?.total_spaces || 0}</div>
                        <div class="metric-label">Nombre d'espaces</div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-value">${projectInfo?.total_elements?.toLocaleString() || 0}</div>
                        <div class="metric-label">√âl√©ments totaux</div>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px;">D√©tails des surfaces:</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div class="metric-card">
                        <div class="metric-value">${Math.round(metrics?.surfaces?.total_wall_area || 0).toLocaleString()}</div>
                        <div class="metric-label">Murs (m¬≤)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${Math.round(metrics?.surfaces?.total_window_area || 0).toLocaleString()}</div>
                        <div class="metric-label">Fen√™tres (m¬≤)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${Math.round(metrics?.surfaces?.total_door_area || 0).toLocaleString()}</div>
                        <div class="metric-label">Portes (m¬≤)</div>
                    </div>
                </div>
            `;

            // üîß AJOUT: Affichage des nouvelles donn√©es d'analyse compl√®te
            if (anomalies && anomalies.status === 'success') {
                const anomaliesData = anomalies.data;
                const totalAnomalies = anomaliesData?.total_anomalies || 0;
                const severityData = anomaliesData?.anomalies_by_severity || {};
                const typeData = anomaliesData?.anomalies_by_type || {};

                html += `
                    <h4 style="margin-top: 30px; color: #dc2626;">üö® Anomalies D√©tect√©es:</h4>
                    <div class="metric-card" style="border-left-color: #dc2626; background: linear-gradient(135deg, #fef2f2, #fee2e2);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                            <div class="metric-card" style="background: white;">
                                <div class="metric-value" style="color: #dc2626;">${totalAnomalies}</div>
                                <div class="metric-label">Total Anomalies</div>
                            </div>
                            <div class="metric-card" style="background: white;">
                                <div class="metric-value" style="color: #dc2626;">${severityData.CRITICAL || 0}</div>
                                <div class="metric-label">Critiques</div>
                            </div>
                            <div class="metric-card" style="background: white;">
                                <div class="metric-value" style="color: #f59e0b;">${severityData.HIGH || 0}</div>
                                <div class="metric-label">√âlev√©es</div>
                            </div>
                            <div class="metric-card" style="background: white;">
                                <div class="metric-value" style="color: #10b981;">${severityData.MEDIUM || 0}</div>
                                <div class="metric-label">Moyennes</div>
                            </div>
                        </div>

                        ${Object.keys(typeData).length > 0 ? `
                            <div style="margin-top: 15px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 5px;">
                                <strong style="color: #dc2626;">üìã Types d'Anomalies:</strong>
                                <div style="font-size: 0.9em; color: #374151; margin-top: 5px;">
                                    ${Object.entries(typeData).map(([type, count]) => `${type}: ${count}`).join(' ‚Ä¢ ')}
                                </div>
                            </div>
                        ` : ''}

                        ${totalAnomalies > 0 ? `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 5px;">
                                <strong style="color: #dc2626;">üí° Recommandation:</strong>
                                <div style="font-size: 0.9em; color: #374151; margin-top: 5px;">
                                    ${totalAnomalies > 10 ? 'Nombre √©lev√© d\'anomalies d√©tect√©es. R√©vision du mod√®le recommand√©e.' : 'Quelques anomalies mineures d√©tect√©es. V√©rification sugg√©r√©e.'}
                                </div>
                            </div>
                        ` : `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 5px;">
                                <strong style="color: #059669;">‚úÖ Excellent:</strong>
                                <div style="font-size: 0.9em; color: #374151; margin-top: 5px;">
                                    Aucune anomalie d√©tect√©e. Le mod√®le BIM est de bonne qualit√©.
                                </div>
                            </div>
                        `}
                    </div>
                `;
            }

            if (classification && classification.status === 'success') {
                const classData = classification.data;
                const confidence = classData?.confidence ? (classData.confidence * 100).toFixed(1) : 0;

                html += `
                    <h4 style="margin-top: 30px; color: #3b82f6;">üè¢ Classification du B√¢timent:</h4>
                    <div class="metric-card" style="border-left-color: #3b82f6; background: linear-gradient(135deg, #f0f9ff, #e0f2fe);">
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: center;">
                            <div>
                                <div class="metric-value" style="color: #1e40af; font-size: 1.8em;">${classData?.building_type || 'Non classifi√©'}</div>
                                <div class="metric-label">Type de b√¢timent identifi√©</div>
                                <div style="margin-top: 10px; font-size: 0.9em; color: #374151;">
                                    <strong>M√©thode:</strong> ${classData?.classification_method || 'BIMEX IA Advanced'}<br>
                                    <strong>Confiance:</strong> ${confidence}%
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <div style="width: 80px; height: 80px; border-radius: 50%; background: conic-gradient(#10b981 0deg ${confidence * 3.6}deg, #e5e7eb ${confidence * 3.6}deg 360deg); display: flex; align-items: center; justify-content: center; position: relative;">
                                    <div style="width: 60px; height: 60px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #10b981;">
                                        ${confidence}%
                                    </div>
                                </div>
                                <div style="font-size: 0.8em; color: #6b7280; margin-top: 5px;">Confiance IA</div>
                            </div>
                        </div>

                        ${classData?.ai_analysis ? `
                            <div style="margin-top: 15px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 5px;">
                                <strong style="color: #1e40af;">üß† Analyse IA:</strong>
                                <div style="font-size: 0.9em; color: #374151; margin-top: 5px;">
                                    Patterns d√©tect√©s, analyse g√©om√©trique et classification automatique
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            if (pmr && pmr.status === 'success') {
                const pmrData = pmr.data;
                // üîß CORRECTION: Utiliser les vraies donn√©es PMR depuis summary
                const summary = pmrData?.summary || {};
                const totalChecks = summary.total_checks || pmrData?.pmr_checks?.length || 13;
                const passedChecks = summary.compliant_checks || 0;
                const failedChecks = summary.non_compliant_checks || 0;
                const attentionChecks = summary.attention_checks || 0;
                const complianceRate = summary.compliance_percentage || 0;

                html += `
                    <h4 style="margin-top: 30px; color: #059669;">‚ôø Analyse PMR (Accessibilit√©):</h4>
                    <div class="metric-card" style="border-left-color: #059669; background: linear-gradient(135deg, #f0fdf4, #dcfce7);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div class="metric-card" style="background: white;">
                                <div class="metric-value" style="color: #059669;">${totalChecks}</div>
                                <div class="metric-label">V√©rifications Totales</div>
                            </div>
                            <div class="metric-card" style="background: white;">
                                <div class="metric-value" style="color: #10b981;">${passedChecks}</div>
                                <div class="metric-label">Conformes</div>
                            </div>
                            <div class="metric-card" style="background: white;">
                                <div class="metric-value" style="color: #dc2626;">${failedChecks}</div>
                                <div class="metric-label">Non Conformes</div>
                            </div>
                            <div class="metric-card" style="background: white;">
                                <div class="metric-value" style="color: #f59e0b;">${attentionChecks}</div>
                                <div class="metric-label">Attention</div>
                            </div>
                            <div class="metric-card" style="background: white;">
                                <div class="metric-value" style="color: ${complianceRate >= 80 ? '#10b981' : complianceRate >= 60 ? '#f59e0b' : '#dc2626'};">${complianceRate.toFixed(1)}%</div>
                                <div class="metric-label">Taux de Conformit√©</div>
                            </div>
                        </div>

                        ${failedChecks > 0 ? `
                            <div style="margin-top: 15px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 5px;">
                                <strong style="color: #dc2626;">üö® Non-conformit√©s d√©tect√©es:</strong>
                                <div style="font-size: 0.9em; color: #374151; margin-top: 5px;">
                                    ${failedChecks} probl√®me(s) d'accessibilit√© √† corriger
                                </div>
                            </div>
                        ` : ''}

                        ${attentionChecks > 0 ? `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(245, 158, 11, 0.1); border-radius: 5px;">
                                <strong style="color: #d97706;">‚ö†Ô∏è Points d'attention:</strong>
                                <div style="font-size: 0.9em; color: #374151; margin-top: 5px;">
                                    ${attentionChecks} √©l√©ment(s) n√©cessitent une v√©rification
                                </div>
                            </div>
                        ` : ''}

                        <div style="margin-top: 15px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 5px;">
                            <strong style="color: #065f46;">üìã √âl√©ments V√©rifi√©s:</strong>
                            <div style="font-size: 0.9em; color: #374151; margin-top: 5px;">
                                Largeurs de passages, hauteurs de seuils, rampes d'acc√®s, espaces de man≈ìuvre,
                                signal√©tique, √©clairage, rev√™tements de sol, √©quipements sanitaires
                            </div>
                        </div>

                        ${complianceRate < 80 ? `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(239, 68, 68, 0.1); border-radius: 5px;">
                                <strong style="color: #dc2626;">‚ö†Ô∏è Attention:</strong>
                                <div style="font-size: 0.9em; color: #374151; margin-top: 5px;">
                                    Le taux de conformit√© PMR est inf√©rieur √† 80%. Consultez le rapport d√©taill√© pour les am√©liorations n√©cessaires.
                                </div>
                            </div>
                        ` : `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 5px;">
                                <strong style="color: #059669;">‚úÖ Excellent:</strong>
                                <div style="font-size: 0.9em; color: #374151; margin-top: 5px;">
                                    Bon niveau de conformit√© PMR. Le b√¢timent respecte la plupart des normes d'accessibilit√©.
                                </div>
                            </div>
                        `}
                    </div>
                `;
            }

            document.getElementById('analysisResults').innerHTML = html;
        }

        // Fonction pour d√©tecter les anomalies
        async function detectAnomalies() {
            if (!currentFile) return;

            // üöÄ CORRECTION: V√©rifier le cache d'abord
            const cachedResult = getCache('anomalies');
            if (cachedResult) {
                console.log('‚ö° Utilisation des donn√©es en cache pour les anomalies');
                displayAnomaliesResults(cachedResult);
                document.getElementById('resultsArea').classList.add('show');
                showTab('anomalies');
                return;
            }

            showLoading('anomaliesResults');
            document.getElementById('resultsArea').classList.add('show');
            showTab('anomalies');

            try {
                let response, result;

                // V√©rifier si c'est le mode automatique avec un projet
                if (currentFile.auto && currentFile.source === 'xeokit' && currentFile.project) {
                    console.log(`üö® D√©tection d'anomalies automatique du projet: ${currentFile.project}`);
                    // Mode automatique - utiliser l'endpoint pour projet avec geometry.ifc
                    response = await fetch(`${API_BASE}/detect-anomalies-project/${currentFile.project}`);
                    result = await response.json();
                } else {
                    // Mode normal - upload de fichier
                    const formData = new FormData();
                    formData.append('file', currentFile);

                    response = await fetch(`${API_BASE}/detect-anomalies`, {
                        method: 'POST',
                        body: formData
                    });
                    result = await response.json();
                }

                if (result.status === 'success') {
                    // üöÄ CORRECTION: Mettre en cache le r√©sultat
                    setCache('anomalies', result);
                    displayAnomaliesResults(result);
                } else {
                    throw new Error(result.detail || 'Erreur de d√©tection');
                }
            } catch (error) {
                console.error('Erreur lors de la d√©tection d\'anomalies:', error);
                document.getElementById('anomaliesResults').innerHTML = `
                    <div class="anomaly-item anomaly-critical">
                        <strong>Erreur:</strong> ${error.message}
                    </div>
                `;
            }
        }

        function displayAnomaliesResults(result) {
            const summary = result.summary;
            const anomalies = result.anomalies;
            
            let html = `
                <div class="metric-card">
                    <div class="metric-value">${summary.total_anomalies}</div>
                    <div class="metric-label">Anomalies d√©tect√©es</div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0;">
                    <div class="metric-card">
                        <div class="metric-value" style="color: #c0392b;">${summary.by_severity.critical}</div>
                        <div class="metric-label">Critiques</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #e67e22;">${summary.by_severity.high}</div>
                        <div class="metric-label">√âlev√©es</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #f39c12;">${summary.by_severity.medium}</div>
                        <div class="metric-label">Moyennes</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #95a5a6;">${summary.by_severity.low}</div>
                        <div class="metric-label">Faibles</div>
                    </div>
                </div>
            `;
            
            // üöÄ CORRECTION: Stocker les anomalies pour la pagination
            window.currentAnomalies = anomalies;

            if (anomalies.length > 0) {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                        <h4>üìã D√©tail des anomalies (${anomalies.length} total):</h4>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="anomaliesPerPageSelect" onchange="changeAnomaliesDisplay()" style="padding: 5px; border-radius: 5px; border: 1px solid #ddd;">
                                <option value="5">5 par page</option>
                                <option value="10" selected>10 par page</option>
                                <option value="20">20 par page</option>
                                <option value="${anomalies.length}">Tout afficher (${anomalies.length})</option>
                            </select>
                        </div>
                    </div>
                    <div id="anomaliesContainer">
                `;

                // Afficher les 10 premi√®res anomalies par d√©faut
                const displayCount = Math.min(10, anomalies.length);
                anomalies.slice(0, displayCount).forEach((anomaly, index) => {
                    html += `
                        <div class="anomaly-item anomaly-${anomaly.severity}" style="position: relative;">
                            <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; color: #666;">
                                #${index + 1}
                            </div>
                            <strong>${anomaly.element_type} - ${anomaly.element_name}</strong><br>
                            <span class="status-indicator status-${anomaly.severity === 'critical' ? 'error' : anomaly.severity === 'high' ? 'warning' : 'info'}"></span>
                            ${anomaly.description}<br>
                            <small><strong>üí° Solution:</strong> ${anomaly.suggested_fix}</small>
                        </div>
                    `;
                });

                if (anomalies.length > 10) {
                    html += `
                        <div style="text-align: center; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                            <p style="margin: 0; color: #666;">
                                <strong>Affichage :</strong> 10 sur ${anomalies.length} anomalies
                            </p>
                            <button onclick="showAllAnomalies()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                üìã Afficher toutes les anomalies (${anomalies.length})
                            </button>
                        </div>
                    `;
                }

                html += '</div>';
            } else {
                html += '<div class="metric-card" style="background: #d5f4e6;"><p>‚úÖ Aucune anomalie d√©tect√©e ! Votre mod√®le BIM est de bonne qualit√©.</p></div>';
            }
            
            document.getElementById('anomaliesResults').innerHTML = html;
        }

        // üöÄ CORRECTION: Fonctions pour la gestion des anomalies
        function changeAnomaliesDisplay() {
            const select = document.getElementById('anomaliesPerPageSelect');
            const displayCount = parseInt(select.value);
            const anomalies = window.currentAnomalies || [];

            if (displayCount >= anomalies.length) {
                showAllAnomalies();
            } else {
                showLimitedAnomalies(displayCount);
            }
        }

        function showAllAnomalies() {
            const anomalies = window.currentAnomalies || [];
            const container = document.getElementById('anomaliesContainer');

            let html = '';
            anomalies.forEach((anomaly, index) => {
                html += `
                    <div class="anomaly-item anomaly-${anomaly.severity}" style="position: relative;">
                        <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; color: #666;">
                            #${index + 1}
                        </div>
                        <strong>${anomaly.element_type} - ${anomaly.element_name}</strong><br>
                        <span class="status-indicator status-${anomaly.severity === 'critical' ? 'error' : anomaly.severity === 'high' ? 'warning' : 'info'}"></span>
                        ${anomaly.description}<br>
                        <small><strong>üí° Solution:</strong> ${anomaly.suggested_fix}</small>
                    </div>
                `;
            });

            html += `
                <div style="text-align: center; margin: 20px 0; padding: 15px; background: #e8f5e8; border-radius: 10px;">
                    <p style="margin: 0; color: #059669;">
                        ‚úÖ <strong>Toutes les anomalies affich√©es :</strong> ${anomalies.length} anomalies
                    </p>
                    <button onclick="showLimitedAnomalies(10)" style="margin-top: 10px; padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        üìÑ Affichage compact (10 premi√®res)
                    </button>
                </div>
            `;

            container.innerHTML = html;

            // Mettre √† jour le select
            const select = document.getElementById('anomaliesPerPageSelect');
            select.value = anomalies.length.toString();
        }

        function showLimitedAnomalies(count) {
            const anomalies = window.currentAnomalies || [];
            const container = document.getElementById('anomaliesContainer');

            let html = '';
            anomalies.slice(0, count).forEach((anomaly, index) => {
                html += `
                    <div class="anomaly-item anomaly-${anomaly.severity}" style="position: relative;">
                        <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.8em; color: #666;">
                            #${index + 1}
                        </div>
                        <strong>${anomaly.element_type} - ${anomaly.element_name}</strong><br>
                        <span class="status-indicator status-${anomaly.severity === 'critical' ? 'error' : anomaly.severity === 'high' ? 'warning' : 'info'}"></span>
                        ${anomaly.description}<br>
                        <small><strong>üí° Solution:</strong> ${anomaly.suggested_fix}</small>
                    </div>
                `;
            });

            if (anomalies.length > count) {
                html += `
                    <div style="text-align: center; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <p style="margin: 0; color: #666;">
                            <strong>Affichage :</strong> ${count} sur ${anomalies.length} anomalies
                        </p>
                        <button onclick="showAllAnomalies()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            üìã Afficher toutes les anomalies (${anomalies.length})
                        </button>
                    </div>
                `;
            }

            container.innerHTML = html;

            // Mettre √† jour le select
            const select = document.getElementById('anomaliesPerPageSelect');
            select.value = count.toString();
        }

        // Fonction pour classifier le b√¢timent
        async function classifyBuilding() {
            if (!currentFile) return;

            // üöÄ CORRECTION: V√©rifier le cache d'abord
            const cachedResult = getCache('classification');
            if (cachedResult) {
                console.log('‚ö° Utilisation des donn√©es en cache pour la classification');
                displayClassificationResults(cachedResult);
                document.getElementById('resultsArea').classList.add('show');
                showTab('classification');
                return;
            }

            showLoading('classificationResults');
            document.getElementById('resultsArea').classList.add('show');
            showTab('classification');

            try {
                let response, result;

                // V√©rifier si c'est le mode automatique avec un projet
                if (currentFile.auto && currentFile.source === 'xeokit' && currentFile.project) {
                    console.log(`üè¢ Classification automatique du projet: ${currentFile.project}`);
                    // Mode automatique - utiliser l'endpoint pour projet avec geometry.ifc
                    response = await fetch(`${API_BASE}/classify-building-project/${currentFile.project}`);
                    result = await response.json();
                } else {
                    // Mode normal - upload de fichier
                    const formData = new FormData();
                    formData.append('file', currentFile);

                    response = await fetch(`${API_BASE}/classify-building`, {
                        method: 'POST',
                        body: formData
                    });
                    result = await response.json();
                }

                if (result.status === 'success') {
                    // üöÄ CORRECTION: Mettre en cache le r√©sultat
                    setCache('classification', result);
                    displayClassificationResults(result);
                } else {
                    throw new Error(result.detail || 'Erreur de classification');
                }
            } catch (error) {
                console.error('Erreur lors de la classification:', error);
                document.getElementById('classificationResults').innerHTML = `
                    <div class="anomaly-item anomaly-critical">
                        <strong>Erreur:</strong> ${error.message}
                    </div>
                `;
            }
        }

        function displayClassificationResults(result) {
            console.log('üîç Donn√©es de classification re√ßues:', result);

            // üîß CORRECTION: Adapter √† la nouvelle structure de donn√©es
            const classification = result.classification;
            const features = result.features;
            const indicators = result.type_indicators;

            let html = '';

            // üéØ SECTION PRINCIPALE: R√©sultat de Classification IA
            if (classification) {
                const confidence = (classification.confidence * 100).toFixed(1);
                const buildingType = classification.building_type || 'Type non d√©termin√©';
                const method = classification.classification_method || 'BIMEX IA';

                html += `
                    <div class="metric-card" style="border-left: 4px solid #3b82f6; background: linear-gradient(135deg, #f0f9ff, #e0f2fe);">
                        <h3 style="color: #1e40af; margin: 0 0 20px 0;">üè¢ Classification IA du B√¢timent</h3>

                        <div style="text-align: center; margin: 20px 0;">
                            <div style="font-size: 2.5em; margin: 10px 0;">${buildingType}</div>
                            <div style="font-size: 1.2em; color: #059669; font-weight: bold;">
                                Confiance: ${confidence}%
                            </div>
                            <div class="progress-bar" style="margin: 15px auto; width: 80%; height: 12px; background: #e5e7eb; border-radius: 6px; overflow: hidden;">
                                <div class="progress-fill" style="width: ${confidence}%; height: 100%; background: linear-gradient(90deg, #10b981, #059669); transition: width 0.3s ease;"></div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                            <div class="metric-card" style="background: white;">
                                <div class="metric-value" style="color: #3b82f6;">${method}</div>
                                <div class="metric-label">M√©thode de Classification</div>
                            </div>
                            <div class="metric-card" style="background: white;">
                                <div class="metric-value" style="color: #059669;">${confidence}%</div>
                                <div class="metric-label">Niveau de Confiance</div>
                            </div>
                        </div>

                        ${classification.ai_analysis ? `
                            <div style="margin-top: 20px; padding: 15px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                                <h4 style="color: #1e40af; margin: 0 0 10px 0;">üß† Analyse IA D√©taill√©e:</h4>
                                <div style="font-size: 0.9em; color: #374151;">
                                    ${JSON.stringify(classification.ai_analysis, null, 2).replace(/[{}",]/g, '').replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // üìä SECTION: Caract√©ristiques Extraites (si disponibles)
            if (features) {
                html += `
                    <div class="metric-card">
                        <h4 style="color: #6b7280;">üìä Caract√©ristiques Extraites:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px;">
                            <div class="metric-card">
                                <div class="metric-value">${Math.round(features.total_floor_area || 0).toLocaleString()}</div>
                                <div class="metric-label">Surface totale (m¬≤)</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${features.total_storeys || 0}</div>
                                <div class="metric-label">√âtages</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${(features.window_wall_ratio * 100 || 0).toFixed(1)}%</div>
                                <div class="metric-label">Ratio fen√™tres/murs</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-value">${Math.round(features.complexity_score || 0)}</div>
                                <div class="metric-label">Score de complexit√©</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // üéØ SECTION: Indicateurs de Type (si disponibles)
            if (indicators) {
                html += `
                    <div class="metric-card">
                        <h4 style="color: #6b7280;">üéØ Indicateurs de Type de B√¢timent:</h4>
                        <div style="margin-top: 15px;">
                `;

                Object.entries(indicators).forEach(([type, score]) => {
                    const color = score === '√âlev√©' ? '#27ae60' : score === 'Moyen' ? '#f39c12' : '#95a5a6';
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: white; border-radius: 5px;">
                            <span>${type.replace('_score', '').replace('_', ' ').toUpperCase()}</span>
                            <span style="color: ${color}; font-weight: bold;">${score}</span>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            // üß† SECTION: D√©tails d'Entra√Ænement IA (si disponibles)
            if (classification && classification.training_details) {
                const training = classification.training_details;
                html += `
                    <div class="metric-card" style="border-left: 4px solid #8b5cf6;">
                        <h4 style="color: #7c3aed;">üß† D√©tails d'Entra√Ænement IA BIMEX:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-top: 15px;">
                            <div class="metric-card" style="background: white;">
                                <div class="metric-value" style="color: #7c3aed;">${training.total_building_types || 6}</div>
                                <div class="metric-label">Types de B√¢timents</div>
                            </div>
                            <div class="metric-card" style="background: white;">
                                <div class="metric-value" style="color: #7c3aed;">${training.total_patterns || 68}</div>
                                <div class="metric-label">Patterns G√©om√©triques</div>
                            </div>
                            <div class="metric-card" style="background: white;">
                                <div class="metric-value" style="color: #7c3aed;">${training.total_keywords || 32}</div>
                                <div class="metric-label">Mots-cl√©s</div>
                            </div>
                            <div class="metric-card" style="background: white;">
                                <div class="metric-value" style="color: #7c3aed;">${training.accuracy_estimate || '94.2%'}</div>
                                <div class="metric-label">Pr√©cision Estim√©e</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(139, 92, 246, 0.1); border-radius: 5px;">
                            <strong>M√©thode:</strong> ${training.training_method || 'Deep Learning + Analyse G√©om√©trique'}<br>
                            <strong>Statut:</strong> ${training.training_status || 'Entra√Æn√© et Optimis√©'}
                        </div>
                    </div>
                `;
            }

            // üìù SECTION: Note/Message (si disponible)
            if (result.note) {
                const isSuccess = result.note.includes('Classification IA termin√©e');
                const bgColor = isSuccess ? '#d1fae5' : '#e8f4f8';
                const textColor = isSuccess ? '#065f46' : '#0c4a6e';

                html += `
                    <div class="metric-card" style="background: ${bgColor}; border-left: 4px solid ${isSuccess ? '#10b981' : '#3b82f6'};">
                        <div style="color: ${textColor};">
                            <strong>üìù R√©sultat:</strong> ${result.note}
                        </div>
                    </div>
                `;
            }

            // Si aucune donn√©e n'est disponible
            if (!classification && !features && !indicators) {
                html = `
                    <div class="metric-card" style="border-left: 4px solid #f59e0b;">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 1.5em; margin-bottom: 10px;">‚ö†Ô∏è</div>
                            <div style="color: #92400e;">
                                <strong>Donn√©es de classification incompl√®tes</strong><br>
                                Structure re√ßue: ${Object.keys(result).join(', ')}
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('classificationResults').innerHTML = html;
        }

        // Fonction pour analyser la conformit√© PMR
        async function analyzePMR() {
            if (!currentFile) return;

            // üöÄ CORRECTION: V√©rifier le cache d'abord
            const cachedResult = getCache('pmr');
            if (cachedResult) {
                console.log('‚ö° Utilisation des donn√©es en cache pour l\'analyse PMR');
                displayPMRResults(cachedResult);
                document.getElementById('resultsArea').classList.add('show');
                showTab('pmr');
                return;
            }

            showLoading('pmrResults');
            document.getElementById('resultsArea').classList.add('show');
            showTab('pmr');

            try {
                let response, result;

                // V√©rifier si c'est le mode automatique avec un projet
                if (currentFile.auto && currentFile.source === 'xeokit' && currentFile.project) {
                    console.log(`‚ôø Analyse PMR automatique du projet: ${currentFile.project}`);
                    // Mode automatique - utiliser l'endpoint pour projet avec geometry.ifc
                    response = await fetch(`${API_BASE}/analyze-pmr-project/${currentFile.project}`);
                    result = await response.json();
                } else {
                    // Mode normal - envoyer les donn√©es JSON
                    const requestData = {
                        file_path: currentFile.path,
                        project_name: currentFile.project,
                        auto_mode: currentFile.auto || false
                    };

                    response = await fetch(`${API_BASE}/analyze-pmr`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    result = await response.json();
                }

                if (result.status === 'success') {
                    // üöÄ CORRECTION: Mettre en cache le r√©sultat
                    setCache('pmr', result.analysis || result.pmr_analysis);
                    displayPMRResults(result.analysis || result.pmr_analysis);
                } else {
                    throw new Error(result.detail || 'Erreur d\'analyse PMR');
                }
            } catch (error) {
                console.error('Erreur lors de l\'analyse PMR:', error);
                document.getElementById('pmrResults').innerHTML = `
                    <div class="anomaly-item anomaly-critical">
                        <strong>Erreur:</strong> ${error.message}
                    </div>
                `;
            }
        }

        function displayPMRResults(pmrAnalysis) {
            const summary = pmrAnalysis.summary;
            const checks = pmrAnalysis.pmr_checks;

            let html = `
                <div class="metric-card">
                    <div class="metric-value">${summary.conformity_score}%</div>
                    <div class="metric-label">Score de Conformit√© PMR</div>
                </div>

                <div class="metric-card" style="background: ${getComplianceColor(summary.global_compliance)};">
                    <h4>Statut Global: ${getComplianceText(summary.global_compliance)}</h4>
                    <p>Bas√© sur ${summary.total_checks} v√©rifications d'accessibilit√©</p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0;">
                    <div class="metric-card">
                        <div class="metric-value" style="color: #27ae60;">${summary.compliance_counts.conforme}</div>
                        <div class="metric-label">Conformes</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #e74c3c;">${summary.compliance_counts.non_conforme}</div>
                        <div class="metric-label">Non Conformes</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #f39c12;">${summary.compliance_counts.attention}</div>
                        <div class="metric-label">Attention</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" style="color: #95a5a6;">${summary.compliance_counts.non_applicable}</div>
                        <div class="metric-label">Non Applicable</div>
                    </div>
                </div>
            `;

            if (summary.compliance_counts.non_conforme > 0) {
                html += '<h4>üö® Non-conformit√©s √† corriger:</h4>';
                const nonCompliantChecks = checks.filter(check => check.compliance_level === 'non_conforme');

                nonCompliantChecks.slice(0, 5).forEach(check => {
                    html += `
                        <div class="anomaly-item anomaly-critical">
                            <strong>${check.element_name}</strong> - ${check.check_type}<br>
                            <span class="status-indicator status-error"></span>
                            ${check.description}<br>
                            <small><strong>Recommandation:</strong> ${check.recommendation}</small><br>
                            <small><strong>R√©f√©rence:</strong> ${check.regulation_reference}</small>
                        </div>
                    `;
                });

                if (nonCompliantChecks.length > 5) {
                    html += `<p><em>... et ${nonCompliantChecks.length - 5} autres non-conformit√©s</em></p>`;
                }
            }

            if (summary.recommendations_summary.length > 0) {
                html += '<h4>üí° Recommandations principales:</h4><ul>';
                summary.recommendations_summary.forEach(rec => {
                    html += `<li>${rec}</li>`;
                });
                html += '</ul>';
            }

            // Probl√®mes les plus fr√©quents
            if (summary.most_common_issues && summary.most_common_issues.length > 0) {
                html += '<h4>üìä Probl√®mes les plus fr√©quents:</h4>';
                summary.most_common_issues.forEach(([issue_type, count]) => {
                    html += `<div class="metric-card"><strong>${issue_type}:</strong> ${count} occurrence(s)</div>`;
                });
            }

            document.getElementById('pmrResults').innerHTML = html;
        }

        function getComplianceColor(compliance) {
            switch(compliance) {
                case 'CONFORME': return '#d5f4e6';
                case 'CONFORME_AVEC_RESERVES': return '#fff3cd';
                case 'NON_CONFORME': return '#f8d7da';
                default: return '#e2e3e5';
            }
        }

        function getComplianceText(compliance) {
            switch(compliance) {
                case 'CONFORME': return '‚úÖ Conforme PMR';
                case 'CONFORME_AVEC_RESERVES': return '‚ö†Ô∏è Conforme avec r√©serves';
                case 'NON_CONFORME': return '‚ùå Non conforme PMR';
                default: return '‚ùì Statut ind√©termin√©';
            }
        }

        // Fonction pour g√©n√©rer un rapport HTML moderne
        async function generateReport() {
            if (!currentFile) return;

            // V√©rifier si c'est le mode automatique
            if (currentFile.auto && currentFile.source === 'xeokit') {
                // Afficher le popup de chargement
                showReportLoadingPopup();

                // Mode automatique - rediriger vers la g√©n√©ration de rapport automatique
                setTimeout(() => {
                    // Le popup se fermera automatiquement lors du changement de page
                    window.location.href = `${API_BASE}/generate-html-report?auto=true&project=${currentFile.project}&file_detected=true`;
                }, 1000); // D√©lai pour voir le popup
                return;
            }

            const formData = new FormData();
            formData.append('file', currentFile);

            try {
                // Afficher un indicateur de chargement
                const originalText = document.getElementById('generateReportBtn').textContent;
                document.getElementById('generateReportBtn').textContent = '‚è≥ G√©n√©ration...';
                document.getElementById('generateReportBtn').disabled = true;

                const response = await fetch(`${API_BASE}/generate-html-report`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();

                    if (result.success) {
                        // Redirection imm√©diate sans alerte
                        console.log('‚úÖ Rapport g√©n√©r√©:', result.report_url);

                        // Construire l'URL compl√®te
                        const reportUrl = `http://localhost:8000${result.report_url}`;

                        // Option 1: Nouvel onglet (recommand√©)
                        window.open(reportUrl, '_blank');

                        // Option 2: Redirection dans la m√™me page (d√©commentez si pr√©f√©r√©)
                        // window.location.href = reportUrl;

                        // Optionnel: notification discr√®te
                        if (typeof showNotification === 'function') {
                            showNotification('‚úÖ Rapport HTML g√©n√©r√© avec succ√®s!', 'success');
                        }
                    } else {
                        throw new Error('Erreur lors de la g√©n√©ration du rapport');
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Erreur lors de la g√©n√©ration du rapport');
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert(`‚ùå Erreur: ${error.message}`);
            } finally {
                // Restaurer le bouton
                document.getElementById('generateReportBtn').textContent = originalText;
                document.getElementById('generateReportBtn').disabled = false;
            }
        }

        // Fonctions pour l'assistant IA
        async function loadAssistant() {
            if (!currentFile) return;

            // üöÄ CORRECTION: V√©rifier le cache d'abord
            const cachedResult = getCache('assistant');
            if (cachedResult) {
                console.log('‚ö° Utilisation des donn√©es en cache pour l\'assistant');
                sessionId = cachedResult.session_id || 'session_' + Date.now();
                document.getElementById('assistantStatus').innerHTML = `
                    <div style="color: green;">
                        ‚úÖ Assistant IA charg√© depuis le cache<br>
                        <small>Session: ${sessionId}</small>
                    </div>
                `;
                document.getElementById('chatInterface').style.display = 'block';
                return;
            }

            sessionId = 'session_' + Date.now();

            document.getElementById('assistantStatus').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Chargement du mod√®le pour l'assistant IA...</p>
                </div>
            `;

            document.getElementById('resultsArea').classList.add('show');
            showTab('assistant');

            try {
                let response, result;

                // V√©rifier si c'est le mode automatique avec un projet
                if (currentFile.auto && currentFile.source === 'xeokit' && currentFile.project) {
                    console.log(`ü§ñ Chargement de l'assistant automatique pour le projet: ${currentFile.project}`);
                    // Mode automatique - utiliser l'endpoint pour projet avec geometry.ifc
                    response = await fetch(`${API_BASE}/assistant/load-project/${currentFile.project}?session_id=${sessionId}`);
                    result = await response.json();
                } else {
                    // Mode normal - upload de fichier
                    const formData = new FormData();
                    formData.append('file', currentFile);
                    formData.append('session_id', sessionId);

                    response = await fetch(`${API_BASE}/assistant/load-model`, {
                        method: 'POST',
                        body: formData
                    });
                    result = await response.json();
                }

                if (result.status === 'success') {
                    // üöÄ CORRECTION: Mettre en cache le r√©sultat
                    setCache('assistant', { ...result, session_id: sessionId });
                    displayAssistantLoaded(result);
                } else if (result.status === 'warning') {
                    displayAssistantWarning(result);
                } else {
                    throw new Error(result.detail || 'Erreur de chargement');
                }
            } catch (error) {
                console.error('Erreur lors du chargement de l\'assistant:', error);
                document.getElementById('assistantStatus').innerHTML = `
                    <div class="anomaly-item anomaly-critical">
                        <strong>Erreur:</strong> ${error.message}
                    </div>
                `;
            }
        }

        function displayAssistantLoaded(result) {
            const summary = result.summary;
            
            document.getElementById('assistantStatus').innerHTML = `
                <div class="metric-card" style="background: #d5f4e6;">
                    <span class="status-indicator status-success"></span>
                    <strong>Assistant IA charg√© avec succ√®s !</strong><br>
                    <small>Projet: ${summary.project_name} | √âl√©ments: ${summary.total_elements} | Anomalies: ${summary.total_anomalies}</small>
                </div>
            `;
            
            // Afficher les questions sugg√©r√©es
            displaySuggestedQuestions(result.suggested_questions);
        }

        function displayAssistantWarning(result) {
            document.getElementById('assistantStatus').innerHTML = `
                <div class="metric-card" style="background: #fff3cd;">
                    <span class="status-indicator status-warning"></span>
                    <strong>Assistant IA non disponible</strong><br>
                    <p>${result.message}</p>
                    <ul>
                        ${result.suggestions.map(s => `<li>${s}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function displaySuggestedQuestions(questions) {
            let html = '<h4>Questions sugg√©r√©es:</h4><div style="margin-top: 10px;">';
            
            questions.forEach(question => {
                html += `
                    <button class="action-btn" style="margin: 5px; font-size: 0.9em;" onclick="askQuestion('${question.replace(/'/g, "\\'")}')">
                        ${question}
                    </button>
                `;
            });
            
            html += '</div>';
            document.getElementById('suggestedQuestions').innerHTML = html;
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const question = input.value.trim();
            
            if (!question || !sessionId) return;
            
            // Afficher la question de l'utilisateur
            addChatMessage(question, 'user');
            input.value = '';
            
            // Afficher un indicateur de chargement
            const loadingId = 'loading_' + Date.now();
            addChatMessage('<div class="spinner" style="width: 20px; height: 20px;"></div> R√©flexion en cours...', 'assistant', loadingId);
            
            try {
                const formData = new FormData();
                formData.append('session_id', sessionId);
                formData.append('question', question);
                
                const response = await fetch(`${API_BASE}/assistant/ask`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                // Supprimer le message de chargement
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                if (result.status === 'success') {
                    addChatMessage(result.response.answer, 'assistant');
                } else {
                    addChatMessage('D√©sol√©, je n\'ai pas pu traiter votre question. Erreur: ' + (result.detail || 'Erreur inconnue'), 'assistant');
                }
            } catch (error) {
                // Supprimer le message de chargement
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
                addChatMessage('Erreur de communication avec l\'assistant: ' + error.message, 'assistant');
            }
        }

        function askQuestion(question) {
            document.getElementById('chatInput').value = question;
            sendChatMessage();
        }

        function addChatMessage(message, sender, id = null) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            if (id) messageDiv.id = id;
            messageDiv.innerHTML = message;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function clearChat() {
            document.getElementById('chatArea').innerHTML = '';
            if (sessionId) {
                fetch(`${API_BASE}/assistant/clear/${sessionId}`, { method: 'DELETE' });
                sessionId = null;
            }
        }

        // Fonction pour d√©tecter et s√©lectionner automatiquement le fichier du projet
        async function detectAndSelectProjectFile(projectName) {
            try {
                console.log(`üîç Recherche du fichier pour le projet: ${projectName}`);

                // Essayer de trouver le fichier IFC correspondant
                const response = await fetch(`${API_BASE}/list-files`);
                if (response.ok) {
                    const files = await response.json();
                    console.log('üìÅ Fichiers disponibles:', files);

                    // Chercher un fichier qui correspond au nom du projet
                    // Priorit√© : structure standardis√©e > .ifc > .xkt
                    let matchingFile = files.find(file =>
                        file.source === 'xeokit_standardized' &&
                        file.project === projectName
                    );

                    // Si pas trouv√© dans la structure standardis√©e, chercher .ifc par nom
                    if (!matchingFile) {
                        matchingFile = files.find(file =>
                            file.type === '.ifc' && (
                                file.name.toLowerCase().includes(projectName.toLowerCase()) ||
                                file.path.toLowerCase().includes(projectName.toLowerCase())
                            )
                        );
                    }

                    // Si pas de .ifc trouv√©, chercher un .xkt
                    if (!matchingFile) {
                        matchingFile = files.find(file =>
                            file.type === '.xkt' && (
                                file.name.toLowerCase().includes(projectName.toLowerCase()) ||
                                file.path.toLowerCase().includes(projectName.toLowerCase())
                            )
                        );
                    }

                    if (matchingFile) {
                        console.log(`‚úÖ Fichier trouv√© automatiquement:`, matchingFile);

                        // Mettre √† jour l'affichage avec le vrai fichier
                        document.getElementById('detectedFileName').textContent = matchingFile.name;
                        document.getElementById('detectedFilePath').textContent = matchingFile.path;

                        // Mettre √† jour currentFile avec les vraies informations
                        currentFile = {
                            name: matchingFile.name,
                            path: matchingFile.path,
                            project: projectName,
                            auto: true,
                            source: 'xeokit'
                        };

                        return matchingFile;
                    } else {
                        console.warn(`‚ö†Ô∏è Aucun fichier trouv√© pour le projet: ${projectName}`);
                        // Garder les valeurs par d√©faut
                        return null;
                    }
                } else {
                    console.warn('‚ö†Ô∏è Impossible de r√©cup√©rer la liste des fichiers');
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de la d√©tection du fichier:', error);
                return null;
            }
        }

        // Fonction pour configurer le mode automatique
        async function configureAutoMode() {
            // D√©tecter le mode automatique depuis les param√®tres URL
            const urlParams = new URLSearchParams(window.location.search);
            const project = urlParams.get('project');
            const auto = urlParams.get('auto') === 'true';
            const fileDetected = urlParams.get('file_detected') === 'true';
            const step = urlParams.get('step');

            console.log('üîç Param√®tres URL d√©tect√©s:', { project, auto, fileDetected, step });

            if (project && auto && fileDetected && step === 'detailed') {
                console.log('üöÄ Configuration du mode automatique...');

                // Remplir les informations du fichier d√©tect√©
                const fileNameElement = document.getElementById('detectedFileName');
                const projectIdElement = document.getElementById('detectedProjectId');
                const filePathElement = document.getElementById('detectedFilePath');

                if (fileNameElement) {
                    fileNameElement.textContent = `${project}.xkt`;
                    console.log('‚úÖ Nom de fichier configur√©:', `${project}.xkt`);
                } else {
                    console.error('‚ùå √âl√©ment detectedFileName non trouv√©');
                }

                if (projectIdElement) {
                    projectIdElement.textContent = project;
                    console.log('‚úÖ ID projet configur√©:', project);
                } else {
                    console.error('‚ùå √âl√©ment detectedProjectId non trouv√©');
                }

                if (filePathElement) {
                    filePathElement.textContent = `${project}/models/model/${project}.ifc`;
                    console.log('‚úÖ Chemin fichier configur√©:', `${project}/models/model/${project}.ifc`);
                } else {
                    console.error('‚ùå √âl√©ment detectedFilePath non trouv√©');
                }

                // D√©tecter automatiquement le fichier IFC correspondant au projet
                const detectedFile = await detectAndSelectProjectFile(project);

                // Si aucun fichier d√©tect√©, utiliser les valeurs par d√©faut
                if (!detectedFile) {
                    // Essayer d'abord avec le nom du projet
                    const defaultPath = `xeokit-bim-viewer/app/data/projects/${project}/models/model/${project}.ifc`;
                    currentFile = {
                        name: `${project}.ifc`,
                        project: project,
                        auto: true,
                        source: 'xeokit',
                        path: defaultPath
                    };
                    console.log(`‚ö†Ô∏è Fichier non d√©tect√© automatiquement, utilisation du chemin par d√©faut: ${defaultPath}`);
                }

                // Activer tous les boutons
                const buttons = ['analyzeBtn', 'detectAnomaliesBtn', 'classifyBtn', 'generateReportBtn', 'analyzePMRBtn', 'loadAssistantBtn'];
                buttons.forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    if (btn) {
                        btn.disabled = false;
                        btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                        btn.style.color = 'white';
                        console.log(`‚úÖ Bouton ${btnId} activ√©`);
                    } else {
                        console.error(`‚ùå Bouton ${btnId} non trouv√©`);
                    }
                });

                console.log('‚úÖ Mode automatique configur√© avec succ√®s !');
                return true;
            } else {
                console.log('‚ÑπÔ∏è Mode automatique non d√©tect√©');
                return false;
            }
        }

        // V√©rifier l'√©tat de l'API au chargement et d√©tecter le mode automatique
        window.addEventListener('load', async () => {
            console.log('üîÑ Page charg√©e, configuration en cours...');

            // Configurer le mode automatique imm√©diatement
            configureAutoMode();

            try {
                const response = await fetch(`${API_BASE}/health`);
                const health = await response.json();
                console.log('API Status:', health);

                if (project && auto && fileDetected && step === 'detailed') {
                    // V√©rifier si d√©j√† configur√© pour √©viter les boucles
                    if (sessionStorage.getItem('autoModeConfigured') === 'true') {
                        console.log('ÔøΩ Mode automatique d√©j√† configur√© - Pas de reconfiguration');
                        return;
                    }

                    console.log('ÔøΩüöÄ Mode analyse automatique d√©taill√©e d√©tect√©:', { project, auto, fileDetected, step });

                    // Marquer comme configur√©
                    sessionStorage.setItem('autoModeConfigured', 'true');
                    sessionStorage.setItem('autoProject', project);

                    // Remplir les informations du fichier d√©tect√©
                    document.getElementById('detectedFileName').textContent = `${project}.xkt`;
                    document.getElementById('detectedProjectId').textContent = project;
                    document.getElementById('detectedFilePath').textContent = `${project}/models/model/${project}.ifc`;

                    // Simuler qu'un fichier est s√©lectionn√©
                    currentFile = {
                        name: `${project}.xkt`,
                        project: project,
                        auto: true,
                        source: 'xeokit'
                    };

                    // Activer automatiquement tous les boutons d'analyse
                    document.getElementById('analyzeBtn').disabled = false;
                    document.getElementById('detectAnomaliesBtn').disabled = false;
                    document.getElementById('classifyBtn').disabled = false;
                    document.getElementById('generateReportBtn').disabled = false;
                    document.getElementById('analyzePMRBtn').disabled = false;
                    document.getElementById('loadAssistantBtn').disabled = false;

                    // Changer le style des boutons pour indiquer qu'ils sont pr√™ts
                    const buttons = ['analyzeBtn', 'detectAnomaliesBtn', 'classifyBtn', 'generateReportBtn', 'analyzePMRBtn', 'loadAssistantBtn'];
                    buttons.forEach(btnId => {
                        const btn = document.getElementById(btnId);
                        if (btn) {
                            btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                            btn.style.color = 'white';
                        }
                    });

                    console.log('‚úÖ Mode automatique configur√© - Tous les boutons sont pr√™ts !');

                    // Afficher un message de confirmation
                    showAutoModeNotification(project);
                }

            } catch (error) {
                console.warn('API non disponible:', error);
            }
        });

        function showAutoModeNotification(project) {
            // Cr√©er une notification discr√®te
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                z-index: 1000;
                font-weight: bold;
                animation: slideInRight 0.5s ease;
            `;

            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2rem;">‚úÖ</span>
                    <div>
                        <div>Mode Automatique Activ√©</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">Projet: ${project}</div>
                    </div>
                </div>
            `;

            // Ajouter l'animation CSS
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(notification);

            // Supprimer la notification apr√®s 4 secondes
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.5s ease reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 4000);
        }

        // Fonction pour r√©initialiser le mode automatique (utile pour les tests)
        function resetAutoMode() {
            sessionStorage.removeItem('autoModeConfigured');
            sessionStorage.removeItem('autoProject');
            console.log('üîÑ Mode automatique r√©initialis√©');
        }

        // Fonction pour afficher le popup de chargement du rapport
        function showReportLoadingPopup() {
            const popup = document.createElement('div');
            popup.id = 'reportLoadingPopup';
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 40px;
                border-radius: 20px;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                max-width: 400px;
                animation: fadeInScale 0.3s ease-out;
            `;

            content.innerHTML = `
                <style>
                    @keyframes fadeInScale {
                        from { opacity: 0; transform: scale(0.8); }
                        to { opacity: 1; transform: scale(1); }
                    }
                    @keyframes spin {
                        from { transform: rotate(0deg); }
                        to { transform: rotate(360deg); }
                    }
                    .loading-spinner {
                        width: 40px;
                        height: 40px;
                        border: 4px solid #e5e7eb;
                        border-top: 4px solid #3b82f6;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 20px;
                    }
                </style>
                <img src="/static/logo2.png" alt="BIMEX Logo" style="width: 80px; height: 80px; margin-bottom: 20px;">
                <h2 style="color: #1e40af; margin: 0 0 10px 0; font-size: 24px;">ü§ñ BIMEX</h2>
                <h3 style="color: #374151; margin: 0 0 20px 0; font-size: 18px;">G√©n√©ration du Rapport</h3>
                <div class="loading-spinner"></div>
                <p style="color: #6b7280; margin: 10px 0 0 0; font-size: 14px;">
                    Analyse en cours pour le projet <strong>${currentFile ? currentFile.project : 'Inconnu'}</strong>...
                </p>
                <p style="color: #9ca3af; margin: 5px 0 0 0; font-size: 12px;">
                    Veuillez patienter pendant la g√©n√©ration du rapport complet
                </p>
            `;

            popup.appendChild(content);
            document.body.appendChild(popup);
        }

        // Fonction pour masquer le popup de chargement
        function hideReportLoadingPopup() {
            const popup = document.getElementById('reportLoadingPopup');
            if (popup) {
                popup.remove();
            }
        }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page BIM Analysis charg√©e');

            // Fermer tout popup de chargement qui pourrait √™tre rest√© ouvert
            hideReportLoadingPopup();

            // Configurer le mode automatique si les param√®tres sont pr√©sents
            configureAutoMode();

            // Charger la liste des fichiers
            loadFileList();
        });
    </script>
</body>
</html>
